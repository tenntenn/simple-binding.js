var sb={expandable:function(){var d=function(){var a=sb.argumentsToArray(arguments);d.funcs.forEach(function(e){e.apply(d,a)})},c=sb.argumentsToArray(arguments);d.funcs=c.filter(function(a){return"function"===typeof a});d.expand=function(a){"function"===typeof a&&d.funcs.push(a);return d};return d},PropagationGuardian:function(d,c){"function"!==typeof d&&(d=function(){return!0});if("number"!==typeof c||0>=c)c=1;this.createPropagation=function(){var a=[],e=function(b,g){e.callStack=function(){return a.concat()};
var f=0;a.forEach(function(a){a===b&&f++});if(c<=f||!d(b,g))return!1;a.push(b);return!0};return e}}};sb.defaultPropagationGuardian=new sb.PropagationGuardian(null,1);
sb.Observer=function(d){if(!d||!d instanceof sb.PropagationGuardian)console.log("hoge"),d=sb.defaultPropagationGuardian;var c=[];this.getPropagationGuardian=function(){return d};this.add=function(a){null===a||"undefined"===typeof a||0>c.indexOf(a)&&c.push(a)};this.notify=function(a,d){c.filter(function(b){var a=!1;Object.keys(b.inputs).forEach(function(c){b.inputs.hasOwnProperty(c)&&b.inputs[c]===d&&(a=!0)});return a}).forEach(function(b){b.notify(a)})};this.remove=function(a){a=c.lastIndexOf(a);
0<=a&&c.splice(a,1)}};sb.Binding=function(d,c,a,e){var b=this;b.inputs=c;b.outputs=a;b.computed=e;b.bind=function(){d.add(b);return b};b.unbind=function(){d.remove(b);return b};b.notify=function(d){var f=e(c),h=d.callStack(),i=h[h.length-1];Object.keys(f).forEach(function(b){var c=a[b];i!==c&&(a.hasOwnProperty(b)&&sb.isObservable(c))&&c.notify(d,f[b])});return b}};sb.isObservable=function(d){return"function"!==typeof d||!d.notify||"function"!==typeof d.notify?!1:!0};
sb.Observable=function(d,c){var a=this;a.property=function(e){var b;void 0!==e&&(b=d.getPropagationGuardian().createPropagation(),a.property.notify(b,e));return c};a.property.notify=function(e,b){e(a.property,b)&&(c=b,d.notify(e,a.property))}};
(function(){sb.ObservableArray=function(d,c){var a=this,e=c;e instanceof Array||(e=[]);a.property=function(){return e.concat()};a.property.notify=function(b){b(a.property,a.property)&&d.notify(b,a.property)};a.property.length=function(){return e.length};a.property.get=function(b){return e[b]};a.property.set=function(b,c){var f=d.getPropagationGuardian().createPropagation();e[b]=c;a.property.notify(f)};"push pop shift unshift splice reverse sort".split(" ").forEach(function(b){"function"===typeof e[b]&&
(a.property[b]=function(){var c=sb.argumentsToArray(arguments),c=e[b].apply(e,c),f=d.getPropagationGuardian().createPropagation();a.property.notify(f);return c})});["concat","map","filter"].forEach(function(b){"function"===typeof e[b]&&(a.property[b]=function(){var a=sb.argumentsToArray(arguments),a=e[b].apply(e,a);return new sb.ObservableArray(d,a)})});"join toString toLocalString indexOf lastIndexOf forEach".split(" ").forEach(function(b){"function"===typeof e[b]&&(a.property[b]=function(){var a=
sb.argumentsToArray(arguments);return e[b].apply(e,a)})})}})();
(function(){sb.BindingChain=function(d,c){var a=sb.expandable(),e=[];this.synchronize=function(){var b=[];sb.argumentsToArray(arguments).forEach(function(a){sb.isObservable(a)&&(b.push(a),0>c.indexOf(a)&&c.push(a))});var g=b.map(function(a){var c={input:a},e={};b.forEach(function(b,c){a!==b&&(e["output"+c]=b)});return new sb.Binding(d,c,e,function(a){var b={};Object.keys(e).forEach(function(c){b[c]=a.input()});return b})});a.expand(function(){e=e.concat(g)});return this};this.computed=function(b,
g){if(!sb.isObservable(b)||"function"!==typeof g)return this;0>c.indexOf(b)&&c.push(b);a.expand(function(){var a={};c.forEach(function(c,d){b!==c&&(a["input"+d]=c)});var h=new sb.Binding(d,a,{output:b},function(a){return{output:g(a)}});e.push(h)});return this};this.onChange=function(b,g){if(!sb.isObservable(b)||"function"!==typeof g)return this;c.indexOf(b)&&c.push(b);var f=new sb.Binding(d,{input:b},{},function(){g();return{}});a.expand(function(){e.push(f)});return this};this.bind=function(){this.unbind();
a();e.forEach(function(a){a.bind()});return this};this.unbind=function(){e.forEach(function(a){a.unbind()});e=[];return this}}})();sb.argumentsToArray=function(d){var c=[];Object.keys(d).forEach(function(a){c.push(d[a])});return c};
(function(){var d=new sb.Observer;sb.binding=function(){var c=sb.argumentsToArray(arguments).filter(function(a){return sb.isObservable(a)});return new sb.BindingChain(d,c)};sb.observable=function(c){return(new sb.Observable(d,c)).property};sb.observableArray=function(c){return(new sb.ObservableArray(d,c)).property}})();
